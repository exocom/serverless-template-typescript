---
# Generated by @kalarrs/cli
# Run `kalarrs workspace init`

service:
  name: workspace-test

resources:
  Parameters:
    domainName:
      Type: String
      Default: ${file(../.env/${self:provider.stage}.yml):custom.apiGateway.customDomain.name, file(.env/${self:provider.stage}.yml):custom.apiGateway.customDomain.name}
    restApiName:
      Type: String
      Default: "api-${file(../.env/${self:provider.stage}.yml):custom.apiGateway.name, file(.env/${self:provider.stage}.yml):custom.apiGateway.name}-${self:provider.stage}"
    restApiDescription:
      Type: String
      Default: ${file(../.env/${self:provider.stage}.yml):custom.apiGateway.description, file(.env/${self:provider.stage}.yml):custom.apiGateway.description}
    certificateArn:
      Type: String
      Default: ${file(../.env/${self:provider.stage}.yml):custom.apiGateway.customDomain.certificateArn, file(.env/${self:provider.stage}.yml):custom.apiGateway.customDomain.certificateArn}
    basePath:
      Type: String
      Default: ${file(../.env/${self:provider.stage}.yml):custom.apiGateway.customDomain.basePathMapping, file(.env/${self:provider.stage}.yml):custom.apiGateway.customDomain.basePathMapping}
    stageName:
      Type: String
      Default: ${self:provider.stage}
  Resources:
    WorkspaceRestApi:
      Type: AWS::ApiGateway::RestApi
      Properties:
        Name:
          Ref: restApiName
        Description:
          Ref: restApiDescription
    #     Updating BinaryMediaTypes causes Cloud Formation to freeze.
    #     If you have already deployed the api, please use AWS console to add or remove binary types.
    #        BinaryMediaTypes:
    #        - "audio/mpeg"
    #        - "*/*"
    #          This is default
    #          EndpointConfiguration:
    #            Types:
    #              - "EDGE"

    MockMethod:
      Type: AWS::ApiGateway::Method
      Properties:
        RestApiId:
          Ref: WorkspaceRestApi
        ResourceId:
          Fn::GetAtt:
          - WorkspaceRestApi
          - "RootResourceId"
        HttpMethod: "OPTIONS"
        AuthorizationType: "NONE"
        Integration:
          Type: "MOCK"

    Deployment:
      Type: AWS::ApiGateway::Deployment
      Properties:
        RestApiId:
          Ref: WorkspaceRestApi
        Description:
          Ref: restApiDescription
        StageName:
          Ref: stageName

    DomainName:
      Type: AWS::ApiGateway::DomainName
      Properties:
        CertificateArn:
          Ref: certificateArn
        DomainName:
          Ref: domainName

    BasePathMapping:
      Type: 'AWS::ApiGateway::BasePathMapping'
      Properties:
        BasePath:
          Ref: basePath
        DomainName:
          Ref: DomainName
        RestApiId:
          Ref: WorkspaceRestApi
        Stage: ${self:provider.stage}

  #    NOTE : You'll need to respond to the Cert Email request.
  #    Certificate:
  #      Type: 'AWS::CertificateManager::Certificate'
  #      Properties:
  #        DomainName:
  #          Ref: domainName


  Outputs:
    apiGatewayRestApiId:
      Value:
        Ref: WorkspaceRestApi
      Export:
        Name:
          Fn::Join:
          - ""
          - - Ref: restApiName
            - "-restApiId"

    apiGatewayRestApiRootResourceId:
      Value:
        Fn::GetAtt:
        - WorkspaceRestApi
        - RootResourceId
      Export:
        Name:
          Fn::Join:
          - ""
          - - Ref: restApiName
            - "-rootResourceId"

provider:
  name: aws
  environment: ${file(../.env/${self:provider.stage}.yml):provider.environment, file(.env/${self:provider.stage}.yml):provider.environment}
  profile: default
  region: us-west-2
  stage: ${opt:stage, "dev"}

plugins:
- "@kalarrs/serverless-workspace-utils"

custom:
  user: ${file(serverless-user.yml):custom.user, file(../serverless-user.yml):custom.user}
